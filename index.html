<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pixel Runner - A Platformer Adventure</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            background: linear-gradient(180deg, #87CEEB 0%, #E0F6FF 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .game-container {
            position: relative;
            background: linear-gradient(180deg, #87CEEB 0%, #E0F6FF 70%, #90EE90 100%);
            width: 100vw;
            height: 90vh;
        }

        #gameCanvas {
            display: block;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            width: 100%;
            height: 100%;
        }

        .ui-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            color: white;
            font-size: 10px;
            text-shadow: 3px 3px 0 #000;
            pointer-events: none;
            z-index: 10;
        }

        .game-over-screen,
        .win-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 15px;
            border-radius: 12px;
            border: 4px solid #FFD700;
            text-align: center;
            color: white;
            display: none;
            z-index: 100;
            width: 90vw;
            max-height: 85vh;
            overflow-y: auto;
        }

        .game-over-screen h2,
        .win-screen h2 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #FF6B6B;
        }

        .win-screen h2 {
            color: #FFD700;
        }

        .game-over-screen p,
        .win-screen p {
            font-size: 10px;
            margin: 10px 0;
        }

        button {
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: 4px solid #2E7D32;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s;
        }

        button:hover {
            background: #66BB6A;
            transform: scale(1.05);
        }

        button:active {
            transform: scale(0.95);
        }

        .instructions {
            display: none;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .coin-count {
            animation: float 2s ease-in-out infinite;
        }

        .character-selection {
            position: absolute;
            top: 15vh;
            left: 0;
            width: 100%;
            height: 60%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .character-selection h1 {
            color: #FFD700;
            margin-bottom: 2%;
            font-size: 2.5rem;
        }

        .character-selection h2 {
            font-size: 16px;
            color: #FFD700;
            margin-bottom: 30px;
            text-shadow: 3px 3px 0 #000;
        }

        .character-options {
            display: flex;
            /* flex-direction: column; */
            gap: 20px;
        }

        .character-card {
            background: rgba(255, 255, 255, 0.1);
            border: 4px solid #FFD700;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .character-card:active {
            transform: scale(0.95);
            border-color: #FFF;
            background: rgba(255, 255, 255, 0.2);
        }

        .character-card img {
            width: 100px;
            height: 100px;
            image-rendering: pixelated;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 10px;
        }

        .character-card h3 {
            font-size: 14px;
            color: white;
            text-shadow: 2px 2px 0 #000;
        }

        .character-portrait {
            position: absolute;
            top: 50px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            border: 4px solid #FFD700;
            border-radius: 8px;
            padding: 8px;
            text-align: center;
        }

        .character-portrait img {
            width: 48px;
            height: 48px;
            image-rendering: pixelated;
            display: block;
            margin-bottom: 5px;
        }

        .character-portrait p {
            font-size: 6px;
            color: white;
            text-shadow: 2px 2px 0 #000;
            margin: 0;
        }

        .game-over-screen img,
        .win-screen img {
            width: 20vw;
            height: auto;
            max-width: 120px;
            max-height: 160px;
            image-rendering: pixelated;
            margin-bottom: 10px;
            padding: 2%;
        }

        .game-over-div,
        .win-div {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .mobile-controls {
            position: absolute;
            bottom: 15px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 50;
            pointer-events: none;
        }

        .control-left {
            display: flex;
            gap: 8px;
        }

        .control-right {
            display: flex;
            gap: 8px;
        }

        .control-btn {
            pointer-events: all;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.3);
            border: 3px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            user-select: none;
            touch-action: none;
        }

        .control-btn:active {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(0.95);
        }

        .jump-btn {
            width: 60px;
            height: 60px;
            background: rgba(255, 215, 0, 0.3);
            border-color: rgba(255, 215, 0, 0.8);
        }

        .jump-btn:active {
            background: rgba(255, 215, 0, 0.5);
        }

        .game-over-data,
        .win-data {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Desktop/Tablet - Mayor a 768px */
        @media (min-width: 769px) and (orientation: landscape) {
            .game-container {
                width: 800px;
                height: 450px;
                border: 8px solid #333;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
                border-radius: 8px;
            }

            .ui-overlay {
                top: 20px;
                left: 20px;
                right: 20px;
                font-size: 14px;
            }

            .character-selection {
                top: 0;
                left: 0;
                height: 100%;
            }

            .character-selection h2 {
                font-size: 28px;
                margin-bottom: 50px;
            }

            .character-options {
                flex-direction: row;
                gap: 60px;
            }

            .character-card {
                padding: 30px;
            }

            .character-card:hover {
                transform: scale(1.1);
                border-color: #FFF;
                background: rgba(255, 255, 255, 0.2);
            }

            .character-card img {
                width: 128px;
                height: 128px;
                margin-bottom: 20px;
            }

            .character-card h3 {
                font-size: 16px;
            }

            .character-portrait {
                top: 60px;
                left: 20px;
                padding: 10px;
            }

            .character-portrait img {
                width: 64px;
                height: 64px;
            }

            .character-portrait p {
                font-size: 8px;
            }

            .game-over-screen,
            .win-screen {
                flex-direction: column;
                width: 60vw;
                padding: 40px;
                max-height: none;
            }

            .game-over-screen h2,
            .win-screen h2 {
                font-size: 24px;
                margin-bottom: 20px;
            }

            .game-over-screen p,
            .win-screen p {
                font-size: 12px;
                margin: 15px 0;
            }

            .game-over-screen img,
            .win-screen img {
                width: 290px;
                height: 380px;
                max-width: none;
                max-height: none;
                padding: 3%;
                margin-bottom: 20px;
            }

            button {
                font-size: 12px;
                padding: 15px 30px;
                margin-top: 20px;
            }

            .mobile-controls {
                display: none;
            }

            .instructions {
                display: block;
                position: absolute;
                bottom: -80px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(255, 255, 255, 0.95);
                padding: 20px 40px;
                border-radius: 12px;
                border: 4px solid #333;
                font-size: 10px;
                color: #333;
                white-space: nowrap;
            }

            .instructions span {
                color: #FF6B6B;
                font-weight: bold;
            }

            .game-over-data,
            .win-data {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }
        }

        /* Landscape en m√≥vil */
        /* @media (max-width: 2500px)  {
            .game-container {
                width: 100vw;
                height: 100vh;
            }

            .ui-overlay {
                font-size: 8px;
                top: 5px;
                left: 5px;
                right: 5px;
            }

            .character-portrait {
                top: 30px;
                left: 5px;
                padding: 5px;
            }

            .character-portrait img {
                width: 35px;
                height: 35px;
            }

            .character-portrait p {
                font-size: 5px;
            }

            .character-selection h2 {
                font-size: 14px;
                margin-bottom: 20px;
            }

            .character-options {
                flex-direction: row;
                gap: 30px;
            }

            .character-card {
                padding: 15px;
            }

            .character-card img {
                width: 70px;
                height: 70px;
            }

            .character-card h3 {
                font-size: 10px;
            }

            .mobile-controls {
                bottom: 10px;
                padding: 0 10px;
            }

            .control-btn {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }

            .jump-btn {
                width: 55px;
                height: 55px;
            }

            .game-over-screen,
            .win-screen {
                width: 80vw;
                max-height: 80vh;
                padding: 15px;
            }

            .game-over-screen h2,
            .win-screen h2 {
                font-size: 12px;
                margin-bottom: 8px;
            }

            .game-over-screen p,
            .win-screen p {
                font-size: 8px;
                margin: 8px 0;
            }

            .game-over-screen img,
            .win-screen img {
                width: 80px;
                height: auto;
                max-height: 120px;
            }

            .game-over-div,
            .win-div {
                gap: 8px;
            }

            button {
                font-size: 8px;
                padding: 8px 16px;
                margin-top: 8px;
            }
        } */
    </style>
</head>

<body>
    <div class="game-container">
        <div class="character-selection" id="characterSelection">
            <h1>Minos Adventure</h1>
            <h2>Escoge el jugador</h2>
            <div class="character-options">
                <div class="character-card" onclick="selectCharacter(0)">
                    <img id="char0Img" src="" alt="Character 1">
                    <h3 id="char0Name"></h3>
                </div>
                <div class="character-card" onclick="selectCharacter(1)">
                    <img id="char1Img" src="" alt="Character 2">
                    <h3 id="char1Name"></h3>
                </div>
            </div>
        </div>
        <div class="character-portrait" id="characterPortrait" style="display: none;">
            <img id="portraitImg" src="" alt="Character">
            <p id="portraitName"></p>
        </div>
        <div class="ui-overlay">
            <div class="score">PUNTAJE: <span id="score">0</span></div>
            <div class="coin-count">ü™ô <span id="coins">0</span></div>
            <div class="lives">‚ù§Ô∏è <span id="lives">3</span></div>
        </div>
        <canvas id="gameCanvas" width="800" height="450"></canvas>
        <div class="mobile-controls" id="mobileControls">
            <div class="control-left">
                <div class="control-btn" id="leftBtn">‚óÑ</div>
                <div class="control-btn" id="rightBtn">‚ñ∫</div>
            </div>
            <div class="control-right">
                <div class="control-btn jump-btn" id="jumpBtn">‚ñ≤</div>
            </div>
        </div>
        <div class="game-over-screen" id="gameOverScreen">
            <div class="game-over-div">
                <img id="gameOverAImg" src="./ALs.jpeg" alt="Game Over">
                <img id="gameOverImg" src="" alt="Game Over">
            </div>
            <div class="game-over-data">
                <h2>GAME OVER!</h2>
                <p>Puntaje: <span id="finalScore">0</span></p>
                <button onclick="restartGame()">Intenta de nuevo</button>
            </div>
        </div>

        <div class="win-screen" id="winScreen">
            <div class="win-div">
                <img id="winImg" src="" alt="You Win">
                <img id="winAImg" src="./AW.jpeg" alt="You Win">
            </div>
            <div class="win-data">
                <h2>Ganaste!</h2>
                <p>Felicitaciones!</p>
                <p>Puntaje Final: <span id="winScore">0</span></p>
                <button onclick="restartGame()">Jugar de nuevo</button>
            </div>
        </div>

        <div class="instructions">
            Usa <span>las FLECHAS</span> para moverte y <span>BARRA ESPACIADORA</span> para saltar ‚Ä¢ Acumula monedas ‚Ä¢
            Evita los enemigos ‚Ä¢ Llega a la meta!
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // At the top of your script, after const ctx = canvas.getContext('2d');

        // Player selection
        const playerCharacters = [
            {
                name: "Benja",
                portraitSrc: "BSelect.jpeg", // Image for selection screen
                spriteSrc: "BPlay.jpeg",
                loseSrc: "BL.jpeg",      // Add this
                winSrc: "win.jpeg",    // Image for actual gameplay
                portraitImg: new Image(),
                spriteImg: new Image()
            },
            {
                name: "Feli",
                portraitSrc: "FSelect.jpeg", // Image for selection screen
                spriteSrc: "FPlay.jpeg",
                loseSrc: "FLs.jpeg",      // Add this
                winSrc: "win.jpeg",    // Image for actual gameplay
                portraitImg: new Image(),
                spriteImg: new Image()
            }
        ];

        // Load images
        playerCharacters.forEach(char => {
            char.portraitImg.src = char.portraitSrc;
            char.spriteImg.src = char.spriteSrc;
        });

        let selectedCharacter = null;

        // Game state - change initial value
        let gameState = 'selection'; // selection, playing, gameover, win

        let score = 0;
        let coins = 0;
        let lives = 3;
        let camera = { x: 0 };

        // Player
        const player = {
            x: 100,
            y: 300,
            width: 50,
            height: 50,
            velocityY: 0,
            velocityX: 0,
            speed: 4,
            jumpPower: 12,
            grounded: false,
            direction: 1 // 1 = right, -1 = left
        };

        // Input
        const keys = {};

        // Level design
        const TILE_SIZE = 32;
        const LEVEL_WIDTH = 5000;

        // Platforms
        const platforms = [
            // Ground
            { x: 0, y: 400, width: 800, height: 50 },
            { x: 800, y: 400, width: 400, height: 50 },
            { x: 1300, y: 400, width: 600, height: 50 },
            { x: 2000, y: 400, width: 800, height: 50 },
            { x: 3000, y: 400, width: 1000, height: 50 },
            { x: 4200, y: 400, width: 800, height: 50 },

            // Floating platforms
            { x: 400, y: 300, width: 150, height: 20 },
            { x: 700, y: 250, width: 100, height: 20 },
            { x: 1000, y: 300, width: 150, height: 20 },
            { x: 1400, y: 280, width: 100, height: 20 },
            { x: 1700, y: 320, width: 120, height: 20 },
            { x: 2200, y: 280, width: 150, height: 20 },
            { x: 2500, y: 250, width: 100, height: 20 },
            { x: 2800, y: 300, width: 120, height: 20 },
            { x: 3300, y: 280, width: 150, height: 20 },
            { x: 3700, y: 250, width: 120, height: 20 },
            { x: 4000, y: 300, width: 100, height: 20 },
        ];

        // Coins
        const coinData = [
            { x: 450, y: 250 },
            { x: 500, y: 250 },
            { x: 750, y: 200 },
            { x: 1050, y: 250 },
            { x: 1100, y: 250 },
            { x: 1450, y: 230 },
            { x: 1750, y: 270 },
            { x: 2250, y: 230 },
            { x: 2300, y: 230 },
            { x: 2550, y: 200 },
            { x: 2850, y: 250 },
            { x: 2900, y: 250 },
            { x: 3350, y: 230 },
            { x: 3400, y: 230 },
            { x: 3750, y: 200 },
            { x: 4050, y: 250 },
        ];

        let coinObjects = coinData.map(c => ({ ...c, collected: false, rotation: 0 }));

        // Enemies
        const enemies = [
            { x: 600, y: 368, width: 32, height: 32, speed: 1.5, direction: 1, minX: 500, maxX: 700, velocityY: 0, grounded: true, canJump: false, jumpCount: 0 },
            { x: 1200, y: 368, width: 32, height: 32, speed: 2, direction: 1, minX: 1100, maxX: 1400, velocityY: 0, grounded: true, canJump: false, jumpCount: 0 },
            { x: 1800, y: 368, width: 32, height: 32, speed: 1.8, direction: -1, minX: 1700, maxX: 1900, velocityY: 0, grounded: true, canJump: false, jumpCount: 0 },
            { x: 2400, y: 368, width: 32, height: 32, speed: 2.2, direction: 1, minX: 2200, maxX: 2600, velocityY: 0, grounded: true, canJump: false, jumpCount: 0 },
            { x: 3200, y: 368, width: 32, height: 32, speed: 1.5, direction: -1, minX: 3100, maxX: 3400, velocityY: 0, grounded: true, canJump: false, jumpCount: 0 },
            { x: 3900, y: 368, width: 32, height: 32, speed: 2, direction: 1, minX: 3800, maxX: 4100, velocityY: 0, grounded: true, canJump: false, jumpCount: 0 },
            { x: 4500, y: 368, width: 32, height: 32, speed: 0, direction: 0, minX: 4500, maxX: 4500, velocityY: 0, grounded: true, canJump: true, jumpCount: 0, isBoss: true },
        ];

        // Goal flag
        const goal = { x: 4700, y: 280, width: 40, height: 120 };

        // Initialize character selection screen
        function initCharacterSelection() {
            document.getElementById('char0Img').src = playerCharacters[0].portraitSrc;
            document.getElementById('char0Name').textContent = playerCharacters[0].name;
            document.getElementById('char1Img').src = playerCharacters[1].portraitSrc;
            document.getElementById('char1Name').textContent = playerCharacters[1].name;
        }

        function selectCharacter(index) {
            selectedCharacter = playerCharacters[index];
            document.getElementById('characterSelection').style.display = 'none';
            console.log(selectedCharacter)
            // Show character portrait (use portrait image)
            document.getElementById('portraitImg').src = selectedCharacter.portraitSrc;
            document.getElementById('portraitName').textContent = selectedCharacter.name;
            document.getElementById('characterPortrait').style.display = 'block';

            gameState = 'playing';
        }



        // Event listeners
        document.addEventListener('keydown', (e) => {
            keys[e.code] = true;
            if (e.code === 'Space' && player.grounded && gameState === 'playing') {
                player.velocityY = -player.jumpPower;
                player.grounded = false;

                // Trigger boss enemy to jump
                const boss = enemies.find(e => e.isBoss);
                if (boss && boss.grounded) {
                    boss.jumpCount++;
                    // Every 3rd jump, boss stays grounded to let player pass
                    if (boss.jumpCount % 3 !== 0) {
                        boss.velocityY = -player.jumpPower;
                        boss.grounded = false;
                    }
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            keys[e.code] = false;
        });

        // Mobile controls
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');
        const jumpBtn = document.getElementById('jumpBtn');

        // Touch controls
        leftBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            keys['ArrowLeft'] = true;
        });

        leftBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            keys['ArrowLeft'] = false;
        });

        rightBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            keys['ArrowRight'] = true;
        });

        rightBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            keys['ArrowRight'] = false;
        });

        jumpBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (player.grounded && gameState === 'playing') {
                player.velocityY = -player.jumpPower;
                player.grounded = false;

                // Trigger boss enemy to jump
                const boss = enemies.find(e => e.isBoss);
                if (boss && boss.grounded) {
                    boss.jumpCount++;
                    if (boss.jumpCount % 3 !== 0) {
                        boss.velocityY = -player.jumpPower;
                        boss.grounded = false;
                    }
                }
            }
        });

        jumpBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
        });

        // Mouse controls (para testing en desktop)
        leftBtn.addEventListener('mousedown', () => keys['ArrowLeft'] = true);
        leftBtn.addEventListener('mouseup', () => keys['ArrowLeft'] = false);
        rightBtn.addEventListener('mousedown', () => keys['ArrowRight'] = true);
        rightBtn.addEventListener('mouseup', () => keys['ArrowRight'] = false);
        jumpBtn.addEventListener('mousedown', () => {
            if (player.grounded && gameState === 'playing') {
                player.velocityY = -player.jumpPower;
                player.grounded = false;

                const boss = enemies.find(e => e.isBoss);
                if (boss && boss.grounded) {
                    boss.jumpCount++;
                    if (boss.jumpCount % 3 !== 0) {
                        boss.velocityY = -player.jumpPower;
                        boss.grounded = false;
                    }
                }
            }
        });

        // Prevent default touch behaviors
        document.addEventListener('touchmove', (e) => {
            e.preventDefault();
        }, { passive: false });
        // Physics and collision
        function update() {
            if (gameState !== 'playing') return;

            // Player horizontal movement
            player.velocityX = 0;
            if (keys['ArrowLeft']) {
                player.velocityX = -player.speed;
                player.direction = -1;
            }
            if (keys['ArrowRight']) {
                player.velocityX = player.speed;
                player.direction = 1;
            }

            // Gravity
            player.velocityY += 0.6;

            // Update position
            player.x += player.velocityX;
            player.y += player.velocityY;

            // Camera follows player
            camera.x = player.x - canvas.width / 3;
            camera.x = Math.max(0, Math.min(camera.x, LEVEL_WIDTH - canvas.width));

            // Ground collision
            player.grounded = false;
            platforms.forEach(platform => {
                if (player.x + player.width > platform.x &&
                    player.x < platform.x + platform.width &&
                    player.y + player.height > platform.y &&
                    player.y + player.height < platform.y + 20 &&
                    player.velocityY > 0) {
                    player.y = platform.y - player.height;
                    player.velocityY = 0;
                    player.grounded = true;
                }
            });

            // Death if fall off
            if (player.y > canvas.height + 50) {
                lives--;
                updateUI();
                if (lives <= 0) {
                    gameOver();
                } else {
                    respawnPlayer();
                }
            }

            // Coin collection
            coinObjects.forEach(coin => {
                if (!coin.collected) {
                    coin.rotation += 0.1;
                    if (Math.abs(player.x - coin.x) < 30 && Math.abs(player.y - coin.y) < 30) {
                        coin.collected = true;
                        coins++;
                        score += 100;
                        updateUI();
                    }
                }
            });

            // Enemy movement and collision
            enemies.forEach(enemy => {
                // Apply gravity to boss enemy
                if (enemy.isBoss) {
                    enemy.velocityY += 0.6;
                    enemy.y += enemy.velocityY;

                    // Check ground collision for boss
                    enemy.grounded = false;
                    platforms.forEach(platform => {
                        if (enemy.x + enemy.width > platform.x &&
                            enemy.x < platform.x + platform.width &&
                            enemy.y + enemy.height > platform.y &&
                            enemy.y + enemy.height < platform.y + 20 &&
                            enemy.velocityY > 0) {
                            enemy.y = platform.y - enemy.height;
                            enemy.velocityY = 0;
                            enemy.grounded = true;
                        }
                    });
                } else {
                    // Regular enemy movement
                    enemy.x += enemy.speed * enemy.direction;

                    if (enemy.x <= enemy.minX || enemy.x >= enemy.maxX) {
                        enemy.direction *= -1;
                    }
                }

                // Check collision with player
                if (player.x + player.width > enemy.x &&
                    player.x < enemy.x + enemy.width &&
                    player.y + player.height > enemy.y &&
                    player.y < enemy.y + enemy.height) {

                    // Jump on enemy (stomp)
                    if (player.velocityY > 0 && player.y + player.height - 10 < enemy.y + enemy.height / 2) {
                        if (enemy.isBoss) {
                            enemy.x = -1000; // Remove boss
                            score += 500; // Bonus points for boss
                        } else {
                            enemy.x = -1000; // Remove enemy
                            score += 200;
                        }
                        player.velocityY = -8;
                        updateUI();
                    } else {
                        // Hit by enemy
                        lives--;
                        updateUI();
                        if (lives <= 0) {
                            gameOver();
                        } else {
                            respawnPlayer();
                        }
                    }
                }
            });

            // Check win condition (reach flag)
            if (player.x + player.width > goal.x && player.x < goal.x + goal.width &&
                player.y + player.height > goal.y && player.y < goal.y + goal.height) {
                winGame();
            }
        }

        // Drawing
        function draw() {
            // Clear with gradient sky
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#87CEEB');
            gradient.addColorStop(0.7, '#E0F6FF');
            gradient.addColorStop(1, '#90EE90');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Clouds (parallax background)
            drawClouds();

            ctx.save();
            ctx.translate(-camera.x, 0);

            // Draw platforms
            platforms.forEach(platform => {
                // Grass on top
                ctx.fillStyle = '#2d5016';
                ctx.fillRect(platform.x, platform.y, platform.width, 8);

                // Dirt below
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(platform.x, platform.y + 8, platform.width, platform.height - 8);

                // Border
                ctx.strokeStyle = '#654321';
                ctx.lineWidth = 2;
                ctx.strokeRect(platform.x, platform.y, platform.width, platform.height);
            });

            // Draw coins
            coinObjects.forEach(coin => {
                if (!coin.collected) {
                    ctx.save();
                    ctx.translate(coin.x, coin.y);
                    ctx.rotate(coin.rotation);

                    // Coin
                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.arc(0, 0, 12, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.fillStyle = '#FFA500';
                    ctx.beginPath();
                    ctx.arc(0, 0, 8, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.strokeStyle = '#FF8C00';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(0, 0, 12, 0, Math.PI * 2);
                    ctx.stroke();

                    ctx.restore();
                }
            });

            // Draw enemies
            enemies.forEach(enemy => {
                if (enemy.x > -100) {
                    // Boss enemy gets special appearance
                    if (enemy.isBoss) {
                        ctx.fillStyle = '#4B0082'; // Purple for boss
                        ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);

                        // Crown
                        ctx.fillStyle = '#FFD700';
                        ctx.fillRect(enemy.x + 4, enemy.y - 6, 24, 6);
                        ctx.fillRect(enemy.x + 8, enemy.y - 10, 4, 4);
                        ctx.fillRect(enemy.x + 14, enemy.y - 12, 4, 6);
                        ctx.fillRect(enemy.x + 20, enemy.y - 10, 4, 4);

                        // Eyes
                        ctx.fillStyle = 'red';
                        ctx.fillRect(enemy.x + 8, enemy.y + 8, 6, 6);
                        ctx.fillRect(enemy.x + 18, enemy.y + 8, 6, 6);

                        ctx.fillStyle = 'yellow';
                        ctx.fillRect(enemy.x + 10, enemy.y + 10, 3, 3);
                        ctx.fillRect(enemy.x + 20, enemy.y + 10, 3, 3);

                        // Border
                        ctx.strokeStyle = '#2d0052';
                        ctx.lineWidth = 3;
                        ctx.strokeRect(enemy.x, enemy.y, enemy.width, enemy.height);
                    } else {
                        ctx.fillStyle = '#8B0000';
                        ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);

                        // Eyes
                        ctx.fillStyle = 'white';
                        ctx.fillRect(enemy.x + 8, enemy.y + 8, 6, 6);
                        ctx.fillRect(enemy.x + 18, enemy.y + 8, 6, 6);

                        ctx.fillStyle = 'black';
                        ctx.fillRect(enemy.x + 10 + enemy.direction, enemy.y + 10, 3, 3);
                        ctx.fillRect(enemy.x + 20 + enemy.direction, enemy.y + 10, 3, 3);

                        // Border
                        ctx.strokeStyle = '#4d0000';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(enemy.x, enemy.y, enemy.width, enemy.height);
                    }
                }
            });

            // Draw goal flag
            ctx.fillStyle = '#FFD700';
            ctx.fillRect(goal.x, goal.y, 8, goal.height);

            ctx.fillStyle = '#FF4444';
            ctx.beginPath();
            ctx.moveTo(goal.x + 8, goal.y);
            ctx.lineTo(goal.x + goal.width, goal.y + 20);
            ctx.lineTo(goal.x + 8, goal.y + 40);
            ctx.closePath();
            ctx.fill();

            // Draw player
            if (selectedCharacter && selectedCharacter.spriteImg && selectedCharacter.spriteImg.width > 0) {
                ctx.save();
                if (player.direction === -1) {
                    ctx.scale(-1, 1);
                    ctx.drawImage(selectedCharacter.spriteImg, -player.x - player.width, player.y, player.width, player.height);
                } else {
                    ctx.drawImage(selectedCharacter.spriteImg, player.x, player.y, player.width, player.height);
                }
                ctx.restore();
            } else {
                // Fallback
                ctx.fillStyle = '#FF6B6B';
                ctx.fillRect(player.x, player.y, player.width, player.height);

                // Hat
                ctx.fillStyle = '#C41E3A';
                ctx.fillRect(player.x, player.y, player.width, 8);

                // Eyes
                ctx.fillStyle = 'white';
                const eyeOffset = player.direction === 1 ? 6 : 2;
                ctx.fillRect(player.x + 8 + eyeOffset, player.y + 12, 6, 6);
                ctx.fillRect(player.x + 18 + eyeOffset, player.y + 12, 6, 6);

                ctx.fillStyle = 'black';
                ctx.fillRect(player.x + 10 + eyeOffset + player.direction * 2, player.y + 14, 3, 3);
                ctx.fillRect(player.x + 20 + eyeOffset + player.direction * 2, player.y + 14, 3, 3);

                // Mustache
                ctx.fillStyle = '#654321';
                ctx.fillRect(player.x + 8, player.y + 20, 16, 4);

                // Border
                ctx.strokeStyle = '#C41E3A';
                ctx.lineWidth = 2;
                ctx.strokeRect(player.x, player.y, player.width, player.height);
            }

            ctx.restore(); // This closes the ctx.save() from line 9
        }

        function drawClouds() {
            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';

            const cloudOffset = camera.x * 0.3;

            // Cloud 1
            drawCloud(200 - cloudOffset % 1200, 60);
            drawCloud(600 - cloudOffset % 1200, 100);
            drawCloud(1000 - cloudOffset % 1200, 80);

            // More clouds (wrapping)
            drawCloud(200 - cloudOffset % 1200 + 1200, 60);
            drawCloud(600 - cloudOffset % 1200 + 1200, 100);
            drawCloud(1000 - cloudOffset % 1200 + 1200, 80);
        }

        function drawCloud(x, y) {
            ctx.beginPath();
            ctx.arc(x, y, 20, 0, Math.PI * 2);
            ctx.arc(x + 25, y, 25, 0, Math.PI * 2);
            ctx.arc(x + 50, y, 20, 0, Math.PI * 2);
            ctx.arc(x + 25, y - 15, 18, 0, Math.PI * 2);
            ctx.fill();
        }

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        function updateUI() {
            document.getElementById('score').textContent = score;
            document.getElementById('coins').textContent = coins;
            document.getElementById('lives').textContent = lives;
        }

        function respawnPlayer() {
            player.x = 100;
            player.y = 300;
            player.velocityY = 0;
            player.velocityX = 0;
        }

        function gameOver() {
            gameState = 'gameover';
            document.getElementById('finalScore').textContent = score;
            if (selectedCharacter) {
                document.getElementById('gameOverImg').src = selectedCharacter.loseSrc;
            }
            document.getElementById('gameOverScreen').style.display = 'flex';
            document.getElementById('gameOverScreen').style.justifyContent = 'space-around';
        }

        function winGame() {
            gameState = 'win';
            document.getElementById('winScore').textContent = score;
            if (selectedCharacter) {
                document.getElementById('winImg').src = selectedCharacter.winSrc;
            }
            document.getElementById('winScreen').style.display = 'flex';
            document.getElementById('winScreen').style.justifyContent = 'space-around';
        }

        function restartGame() {
            // Reset game state
            gameState = 'playing';
            score = 0;
            coins = 0;
            lives = 3;
            camera.x = 0;

            // Reset player
            respawnPlayer();

            // Reset coins
            coinObjects = coinData.map(c => ({ ...c, collected: false, rotation: 0 }));

            // Reset enemies
            enemies.forEach((enemy, i) => {
                const originalData = [
                    { x: 600, minX: 500, maxX: 700 },
                    { x: 1200, minX: 1100, maxX: 1400 },
                    { x: 1800, minX: 1700, maxX: 1900 },
                    { x: 2400, minX: 2200, maxX: 2600 },
                    { x: 3200, minX: 3100, maxX: 3400 },
                    { x: 3900, minX: 3800, maxX: 4100 },
                    { x: 4500, minX: 4500, maxX: 4500 },
                ][i];
                enemy.x = originalData.x;
                enemy.minX = originalData.minX;
                enemy.maxX = originalData.maxX;
                enemy.velocityY = 0;
                enemy.grounded = true;
                enemy.jumpCount = 0;
            });

            // Hide screens
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('winScreen').style.display = 'none';
            document.getElementById('characterSelection').style.display = 'flex';

            updateUI();

        }

        // Start game
        initCharacterSelection();
        updateUI();
        gameLoop();
    </script>
</body>

</html>